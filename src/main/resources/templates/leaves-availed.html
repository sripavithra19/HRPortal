<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="fragments/header :: head('Leaves Availed')">
</head>
<body>
    <!-- PASS THE TITLE PARAMETER -->
    <div th:replace="fragments/header :: complete-header('Leaves Availed')"></div>

    <main class="container mt-5">
        <div class="jumbotron">
            <h3>View Leave Details</h3>
            <hr class="my-4">
            
            <div id="leavesAvailedSection">
                <div class="mb-3">
                    <label for="employeeIdInput" class="form-label">Enter Employee ID:</label>
                    <input type="number" id="employeeIdInput" class="form-control" style="width: 200px;">
                    <button onclick="fetchLeaveDetails()" class="btn btn-primary mt-2">
                        <i class="bi bi-search"></i> Fetch Details
                    </button>
                </div>
                
                <div id="leaveDetailsTable"></div>
            </div>
        </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>
    
    <!-- Include your JavaScript files -->
    <script th:src="@{/js/tabulator.js}"></script>
    
    <script>
    // Optional: You can also put this function directly in the HTML
    function fetchLeaveDetails() {
        const employeeId = document.getElementById("employeeIdInput").value;
        if (!employeeId) {
            alert("Please enter an Employee ID.");
            return;
        }

        console.log('Fetching leave details for employee ID:', employeeId);

        // Show loading state
        document.getElementById("leaveDetailsTable").innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading leave details...</p></div>';

        // Call HRPortal backend
        fetch('/client/leaveDetails/' + employeeId, {
            credentials: 'include' // Important for sending authentication
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Employee not found. Please check the Employee ID.');
                } else {
                    throw new Error('Error fetching data. Status: ' + response.status);
                }
            }
            return response.json();
        })
        .then(data => {
            console.log('Received leave details data:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Create the Tabulator table
            new Tabulator("#leaveDetailsTable", {
                data: [data],
                layout: "fitColumns",
                columns: [
                    { title: "Employee ID", field: "employeeId", width: 120 },
                    { title: "Employee Name", field: "employeeName", width: 150 },
                    { title: "Total General Leaves", field: "totalGeneralLeaves", width: 150 },
                    { title: "General Leaves Availed", field: "generalLeavesAvailed", width: 180 },
                    { 
                        title: "General Leaves Balance", 
                        field: "generalBalance",
                        formatter: function(cell, formatterParams, onRendered) {
                            var rowData = cell.getRow().getData();
                            return rowData.totalGeneralLeaves - rowData.generalLeavesAvailed;
                        },
                        width: 160
                    },
                    { title: "Total Privilege Leaves", field: "totalPrivilegeLeaves", width: 160 },
                    { title: "Privilege Leaves Availed", field: "privilegeLeavesAvailed", width: 180 },
                    { 
                        title: "Privilege Leaves Balance", 
                        field: "privilegeBalance",
                        formatter: function(cell, formatterParams, onRendered) {
                            var rowData = cell.getRow().getData();
                            return rowData.totalPrivilegeLeaves - rowData.privilegeLeavesAvailed;
                        },
                        width: 160
                    },
                    { title: "Total Restricted Holidays", field: "totalRestrictedHolidays", width: 180 },
                    { title: "Restricted Holidays Availed", field: "restrictedHolidaysAvailed", width: 200 },
                    { 
                        title: "Restricted Holidays Balance", 
                        field: "restrictedBalance",
                        formatter: function(cell, formatterParams, onRendered) {
                            var rowData = cell.getRow().getData();
                            return rowData.totalRestrictedHolidays - rowData.restrictedHolidaysAvailed;
                        },
                        width: 200
                    }
                ]
            });
        })
        .catch(error => {
            console.error('Error fetching leave details:', error);
            document.getElementById("leaveDetailsTable").innerHTML = 
                '<div class="alert alert-danger">Error: ' + error.message + '</div>';
        });
    }
    </script>
</body>
</html>